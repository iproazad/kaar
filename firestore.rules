rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // تحقق مما إذا كان المستخدم مسجل الدخول
    function isSignedIn() {
      return request.auth != null;
    }
    
    // تحقق مما إذا كان المستخدم مسؤولاً (admin)
    function isAdmin() {
      return isSignedIn() && exists(/databases/$(database)/documents/admins/$(request.auth.uid));
    }
    
    // تحقق مما إذا كان المستخدم مطورًا (superadmin)
    function isSuperAdmin() {
      return isSignedIn() && 
             exists(/databases/$(database)/documents/admins/$(request.auth.uid)) && 
             get(/databases/$(database)/documents/admins/$(request.auth.uid)).data.role == 'superadmin';
    }
    
    // تحقق مما إذا كان المستخدم صاحب أعمال (user عادي)
    function isRegularUser() {
      return isSignedIn() && exists(/databases/$(database)/documents/people/$(request.auth.uid));
    }
    
    // تحقق مما إذا كان المستخدم هو صاحب المستند في مجموعة people
    function isOwnerOfPeopleDoc(peopleId) {
      return isSignedIn() && request.auth.uid == peopleId;
    }
    
    // تحقق من صاحب المستند
    function isOwner(resource) {
      return isSignedIn() && resource.data.createdBy == request.auth.uid;
    }
    
    // سجل التغييرات في قاعدة البيانات
    function logChange() {
      return true && setData('logs', 'changes').append({
        'userId': request.auth.uid,
        'action': request.method,
        'path': request.path,
        'timestamp': request.time,
        'data': request.resource.data
      });
    }
    
    // قواعد المسؤولين (خاص بالمطور superadmin)
    match /admins/{adminId} {
      // يمكن للمسجلين الدخول قراءة بيانات المسؤولين
      allow read: if isSignedIn();
      // فقط المطور (superadmin) يمكنه إنشاء/تعديل/حذف المسؤولين بدون قيود
      allow write: if isSuperAdmin();
    }
    
    // قواعد الأقسام
    match /sections/{sectionId} {
      // يمكن للجميع قراءة الأقسام
      allow read: if true;
      // منح السوبر أدمين كامل الصلاحيات بدون قيود
      allow create, update, delete: if isSuperAdmin();
    }
    
    // قواعد الأشخاص (خاص بالمشرف Admin)
    match /persons/{personId} {
      // يمكن للجميع قراءة بيانات الأشخاص
      allow read: if true;
      // منح السوبر أدمين كامل الصلاحيات بدون قيود
      allow create, update, delete: if isSuperAdmin();
    }
    
    // قواعد المستخدمين العاديين (خاص بصاحب الأعمال user)
    match /people/{peopleId} {
      // يمكن للجميع قراءة بيانات المستخدمين العاديين
      allow read: if true;
      // يمكن للمستخدم العادي إنشاء/تعديل/حذف بياناته الخاصة فقط
      allow create: if isSignedIn() && logChange();
      // منح السوبر أدمين كامل الصلاحيات بدون قيود
      allow update, delete: if isSuperAdmin() || (isOwnerOfPeopleDoc(peopleId) && logChange());
    }
    
    // سجل التغييرات
    match /logs/{logId} {
      allow read: if isAdmin();
      allow create: if isSignedIn();
      allow update, delete: if false; // لا يمكن تعديل أو حذف السجلات
    }
    
    // قاعدة افتراضية لجميع المستندات الأخرى
    match /{document=**} {
      allow read: if isSignedIn();
      // منح السوبر أدمين كامل الصلاحيات بدون قيود
      allow write: if isSuperAdmin();
    }
  }
}

