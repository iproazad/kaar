rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // تحقق مما إذا كان المستخدم مسجل الدخول
    function isSignedIn() {
      return request.auth != null;
    }
    
    // تحقق مما إذا كان المستخدم مسؤولاً
    function isAdmin() {
      return isSignedIn() && exists(/databases/$(database)/documents/admins/$(request.auth.uid));
    }
    
    // تحقق مما إذا كان المستخدم superadmin
    function isSuperAdmin() {
      return isSignedIn() && 
             exists(/databases/$(database)/documents/admins/$(request.auth.uid)) && 
             get(/databases/$(database)/documents/admins/$(request.auth.uid)).data.role == 'superadmin';
    }
    
    // تحقق من صاحب المستند
    function isOwner(resource) {
      return isSignedIn() && resource.data.createdBy == request.auth.uid;
    }
    
    // سجل التغييرات في قاعدة البيانات
    function logChange() {
      return true && setData('logs', 'changes').append({
        'userId': request.auth.uid,
        'action': request.method,
        'path': request.path,
        'timestamp': request.time,
        'data': request.resource.data
      });
    }
    
    // قواعد المسؤولين
    match /admins/{adminId} {
      allow read: if isSignedIn();
      allow write: if isAdmin() || isSuperAdmin();
    }
    
    // قواعد الأقسام
    match /sections/{sectionId} {
      allow read: if true; // يمكن للجميع قراءة الأقسام
      allow create, update, delete: if (isAdmin() || isSuperAdmin()) && logChange();
    }
    
    // قواعد الأشخاص
    match /persons/{personId} {
      allow read: if true; // يمكن للجميع قراءة بيانات الأشخاص
      allow create, update, delete: if (isAdmin() || isSuperAdmin()) && logChange();
    }
    
    // سجل التغييرات
    match /logs/{logId} {
      allow read: if isAdmin();
      allow create: if isSignedIn();
      allow update, delete: if false; // لا يمكن تعديل أو حذف السجلات
    }
    
    // قاعدة افتراضية لجميع المستندات الأخرى
    match /{document=**} {
      allow read: if isSignedIn();
      allow write: if isAdmin() && logChange();
    }
  }
}